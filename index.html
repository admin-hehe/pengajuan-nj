<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Input — REKAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-green-50">

    <div class="max-w-6xl mx-auto p-6 bg-white shadow-md mt-6 rounded-lg">
        <h1 class="text-3xl font-bold mb-4">Form Input — REKAP</h1>
        <p class="text-gray-600 mb-6">
            Masukkan data acara dan produk. Tambah banyak item, total akan dihitung otomatis.
        </p>

        <!-- FORM UTAMA -->
        <form id="rekapForm" class="space-y-4">
            <!-- Tanggal & Kegiatan -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="font-semibold">Tanggal</label>
                    <input type="date" id="tanggal" class="w-full p-2 border rounded">
                </div>

                <div>
                    <label class="font-semibold">Kegiatan</label>
                    <input type="text" id="kegiatan" placeholder="Contoh: Makan malam bersama"
                        class="w-full p-2 border rounded">
                </div>
            </div>

            <!-- Kode Budget + Grand Total -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="font-semibold">Kode Budget</label>
                    <input type="text" id="kodeBudget" class="w-full p-2 border rounded" placeholder="ID-230213...">
                </div>

                <div>
                    <label class="font-semibold">Grand Total</label>
                    <input type="text" id="grandTotal" class="w-full p-2 border rounded bg-gray-100" readonly>
                </div>
            </div>

            <!-- TABEL ITEM -->
            <div class="mt-6">
                <table class="w-full border rounded" id="itemTable">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">Kode</th>
                            <th class="p-2 border">Nama Produk</th>
                            <th class="p-2 border">Jumlah</th>
                            <th class="p-2 border">Stok</th>
                            <th class="p-2 border">Harga</th>
                            <th class="p-2 border">Total</th>
                            <th class="p-2 border">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="itemBody"></tbody>
                </table>
            </div>

            <!-- Tombol -->
            <div class="flex gap-3 mt-4">
                <button type="button" id="addItem"
                    class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
                    + Tambah Item
                </button>

                <button type="submit"
                    class="bg-purple-700 text-white px-4 py-2 rounded shadow hover:bg-purple-800">
                    Submit
                </button>
            </div>
        </form>
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // ============================
        // TAMBAH ITEM KE TABEL
        // ============================
        document.getElementById("addItem").addEventListener("click", addItemRow);

        function addItemRow() {
            const tbody = document.getElementById("itemBody");
            const row = document.createElement("tr");

            row.innerHTML = `
                <td class="border p-2">
                    <input type="text" class="kode w-full p-1 border rounded bg-gray-100" readonly>
                </td>

                <td class="border p-2">
                    <input type="text" class="namaProduk w-full p-1 border rounded" placeholder="ketik atau pilih...">
                </td>

                <td class="border p-2">
                    <input type="number" min="1" class="jumlah w-full p-1 border rounded">
                </td>

                <td class="border p-2">
                    <input type="text" class="stok w-full p-1 border rounded bg-gray-100" readonly>
                </td>

                <td class="border p-2">
                    <input type="text" class="harga w-full p-1 border rounded bg-gray-100" readonly>
                </td>

                <td class="border p-2">
                    <input type="text" class="total w-full p-1 border rounded bg-gray-100" readonly>
                </td>

                <td class="border p-2 text-center">
                    <button class="hapus px-3 py-1 bg-red-600 text-white rounded">Hapus</button>
                </td>
            `;

            tbody.appendChild(row);

            row.querySelector(".namaProduk").addEventListener("input", lookupProduk);
            row.querySelector(".jumlah").addEventListener("input", updateTotal);

            row.querySelector(".hapus").addEventListener("click", () => {
                row.remove();
                hitungGrandTotal();
            });
        }

        // ============================
        // LOOKUP PRODUK DARI SHEET MASTER
        // ============================
        async function lookupProduk(e) {
            const row = e.target.closest("tr");
            const nama = e.target.value.trim();

            if (!nama) return;

            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbx1x8gGJphhqmRAOQpqJtZVs4DHatn6joBgJ7WrAbfy7vbatOYtOs9wI_N67r6arJ5wNQ/exec?nama=" + encodeURIComponent(nama));
                const data = await res.json();

                row.querySelector(".kode").value = data.kode || "";
                row.querySelector(".stok").value = data.stok || "";
                row.querySelector(".harga").value = formatRupiah(data.harga || 0);

            } catch (err) {
                console.error(err);
                alert("Gagal lookup produk.");
            }
        }

        // ============================
        // HITUNG TOTAL PER ITEM
        // ============================
        function updateTotal(e) {
            const row = e.target.closest("tr");

            let qty = Number(row.querySelector(".jumlah").value);
            let stok = Number(row.querySelector(".stok").value);
            let harga = Number((row.querySelector(".harga").value || "0").replace(/\D/g, ""));

            // Validasi jumlah > stok
            if (qty > stok) {
                alert("Jumlah melebihi stok!");
                row.querySelector(".jumlah").value = "";
                row.querySelector(".total").value = "";
                hitungGrandTotal();
                return;
            }

            let total = qty * harga;
            row.querySelector(".total").value = formatRupiah(total);

            hitungGrandTotal();
        }

        // ============================
        // HITUNG GRAND TOTAL
        // ============================
        function hitungGrandTotal() {
            let total = 0;

            document.querySelectorAll(".total").forEach(t => {
                total += Number(t.value.replace(/\D/g, "")) || 0;
            });

            document.getElementById("grandTotal").value = formatRupiah(total);
        }

        // ============================
        // FORMAT RUPIAH
        // ============================
        function formatRupiah(angka) {
            return new Intl.NumberFormat("id-ID").format(angka);
        }

    </script>

</body>
</html>

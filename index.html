<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Input Multi Item</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .form-row {
      margin-bottom: 15px;
    }
    .item-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .item-row input {
      flex: 1;
    }
    button {
      padding: 8px 16px;
      background: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.85;
    }
  </style>
</head>

<body>

  <h2>Form Input Multi Item</h2>

  <div class="form-row">
    <label>Tanggal:</label><br>
    <input type="date" id="tanggal" />
  </div>

  <div class="form-row">
    <label>Nama:</label><br>
    <input type="text" id="nama" placeholder="Nama penginput / pemohon" />
  </div>

  <div class="form-row">
    <label>Kegiatan:</label><br>
    <input type="text" id="kegiatan" placeholder="Isi kegiatan" />
  </div>

  <div class="form-row">
    <label>Kode Budget:</label><br>
    <input type="text" id="kodeBudget" placeholder="Kode budget" />
  </div>

  <h3>Daftar Item</h3>

  <div id="items"></div>
  <button onclick="addItem()">+ Tambah Item</button>

  <div class="form-row" style="margin-top:20px;">
    <label>Grand Total:</label><br>
    <input type="text" id="grandTotal" readonly />
  </div>

  <button style="margin-top:20px;" onclick="submitForm()">Submit</button>

  <script>
    let products = [];
    let endpointGet = "https://script.google.com/macros/s/AKfycbwevC2Ds0bATkb4KQkIcdlI7n4EOBOPhxrOQiZiAEEE6pSGkc21uneRu-4d5Nc9HPB8PA/exec";   // <-- ISI URL WEB APP ANDA (GET)
    let endpointPost = "https://script.google.com/macros/s/AKfycbwevC2Ds0bATkb4KQkIcdlI7n4EOBOPhxrOQiZiAEEE6pSGkc21uneRu-4d5Nc9HPB8PA/exec";  // <-- ISI URL WEB APP ANDA (POST)

    // Ambil produk dari Apps Script
    async function loadProducts() {
      try {
        const res = await fetch(endpointGet);
        const data = await res.json();
        products = data.products || [];
      } catch (err) {
        console.error("Gagal load produk", err);
      }
    }
    loadProducts();

    function addItem() {
      const container = document.getElementById("items");

      const row = document.createElement("div");
      row.classList.add("item-row");

      row.innerHTML = `
        <input type="text" class="namaProduk" placeholder="Nama Produk" list="produkList" />
        <input type="number" class="jumlahProduk" placeholder="Jumlah" />
        <input type="number" class="hargaProduk" placeholder="Harga" readonly />
        <input type="number" class="totalProduk" placeholder="Total" readonly />
        <button type="button" onclick="removeItem(this)">X</button>
      `;

      container.appendChild(row);

      // Auto update harga dan total
      row.querySelector(".namaProduk").addEventListener("change", updateItemPrices);
      row.querySelector(".jumlahProduk").addEventListener("input", updateItemPrices);
    }

    function removeItem(btn) {
      btn.parentElement.remove();
      updateGrandTotal();
    }

    function updateItemPrices() {
      const rows = document.querySelectorAll(".item-row");
      rows.forEach(row => {
        const name = row.querySelector(".namaProduk").value.trim();
        const jumlah = Number(row.querySelector(".jumlahProduk").value || 0);

        const hargaField = row.querySelector(".hargaProduk");
        const totalField = row.querySelector(".totalProduk");

        const product = products.find(p => p.nama === name);

        if (!product) {
          hargaField.value = "";
          totalField.value = "";
          return;
        }

        // harga tanpa titik, misal 67000 bukan 67.000
        hargaField.value = product.harga;

        const total = jumlah * product.harga;
        totalField.value = total; // tanpa format ribuan
      });

      updateGrandTotal();
    }

    function updateGrandTotal() {
      let total = 0;
      document.querySelectorAll(".totalProduk").forEach(t => {
        total += Number(t.value || 0);
      });

      // Grand total tanpa ribuan
      document.getElementById("grandTotal").value = total;
    }

    async function submitForm() {
      const tanggal = document.getElementById("tanggal").value;
      const nama = document.getElementById("nama").value;
      const kegiatan = document.getElementById("kegiatan").value;
      const kodeBudget = document.getElementById("kodeBudget").value;

      const items = [];
      document.querySelectorAll(".item-row").forEach(row => {
        items.push({
          namaProduk: row.querySelector(".namaProduk").value,
          jumlah: Number(row.querySelector(".jumlahProduk").value || 0)
        });
      });

      if (items.length === 0) {
        alert("Minimal 1 item diperlukan");
        return;
      }

      const fd = new FormData();
      fd.append("tanggal", tanggal);
      fd.append("nama", nama);         // <-- FORM BARU
      fd.append("kegiatan", kegiatan);
      fd.append("kodeBudget", kodeBudget);
      fd.append("items", JSON.stringify(items));

      try {
        const res = await fetch(endpointPost, {
          method: "POST",
          mode: "no-cors",
          body: fd
        });

        alert("Data berhasil dikirim!");
      } catch (err) {
        console.error(err);
        alert("Gagal kirim: " + err.message);
      }
    }
  </script>

  <!-- AutoComplete list -->
  <datalist id="produkList"></datalist>

  <script>
    // Update datalist setelah data produk diload
    setTimeout(() => {
      const list = document.getElementById("produkList");
      list.innerHTML = products.map(p => `<option value="${p.nama}">`).join("");
    }, 1500);
  </script>

</body>
</html>

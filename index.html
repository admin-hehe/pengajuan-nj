<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form Input — REKAP</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* Sembunyikan kolom kode di mobile */
  @media (max-width: 640px) {
    .col-kode { display: none; }
    .th-aksi { display: none; }
    .input-nama-produk { width: 100% !important; }
  }

  /* Agar input nama produk sama panjang */
  .input-nama-produk { width: 100%; }

  /* Perbaikan input date supaya icon muncul */
  input[type="date"] {
    appearance: auto !important;
    -webkit-appearance: auto !important;
    background-color: white !important;
  }

  /* Tombol loading */
  .loading {
    pointer-events: none;
    opacity: 0.7;
  }
</style>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow">
  <h1 class="text-xl font-bold mb-4">Form Input REKAP</h1>

  <!-- NOTIF -->
  <div id="notif" class="hidden mb-4 p-3 rounded text-white"></div>

  <!-- FORM -->
  <div class="space-y-3">
    <input type="text" id="namaUser" placeholder="Nama User"
      class="w-full border rounded p-2" required />

    <input type="date" id="tanggal"
      class="w-full border rounded p-2 bg-white" required />

    <input type="text" id="kegiatan" placeholder="Kegiatan"
      class="w-full border rounded p-2" required />

    <input type="text" id="kodeBudget" placeholder="Kode Budget"
      class="w-full border rounded p-2" required />
  </div>

  <!-- PRODUK -->
  <div class="mt-6">
    <div class="font-semibold mb-2">Tambah Produk</div>

    <select id="produkSelect"
      class="input-nama-produk border rounded p-2 mb-2 w-full">
      <option value="">-- pilih produk --</option>
    </select>

    <div class="flex space-x-2">
      <input type="number" id="qtyInput" placeholder="Qty"
        class="border p-2 rounded w-24" />
      <button onclick="tambahItem()"
        class="bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
    </div>
  </div>

  <!-- TABEL ITEM -->
  <div class="mt-6 overflow-x-auto">
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2 col-kode">Kode</th>
          <th class="border p-2">Nama Produk</th>
          <th class="border p-2">Qty</th>
          <th class="border p-2">Harga</th>
          <th class="border p-2">Total</th>
          <th class="border p-2 th-aksi">Aksi</th>
        </tr>
      </thead>
      <tbody id="tbodyItems"></tbody>
    </table>
  </div>

  <!-- SUBMIT -->
  <button id="btnSubmit"
    onclick="submitForm()"
    class="mt-6 bg-green-700 text-white px-5 py-2 rounded w-full font-semibold">
    Submit
  </button>

</div>

<script>
let MASTER = [];
let ITEMS = [];

// --- LOAD MASTER ---
async function loadMaster() {
  try {
    const url = "https://script.google.com/macros/s/AKfycbyt7lbv7XpZ0mhwRN-VAHIeaWnrJeu0ddm4jx4fN5vgdjEuE6JgqLStRxTuxsNMeidAwA/exec?action=getMaster"; // ← ganti URL di sini
    const res = await fetch(url);
    MASTER = await res.json();

    const select = document.getElementById("produkSelect");
    MASTER.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.kode;
      opt.textContent = `${p.nama} — Rp ${p.harga.toLocaleString("id-ID")}`;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error(e);
  }
}
loadMaster();

// --- TAMBAH ITEM ---
function tambahItem() {
  const kode = document.getElementById("produkSelect").value;
  const qty = parseFloat(document.getElementById("qtyInput").value);

  if (!kode || !qty || qty <= 0) {
    showNotif("Isi produk & qty dengan benar", "red");
    return;
  }

  const prod = MASTER.find(p => p.kode == kode);
  const harga = parseFloat(prod.harga);
  const total = harga * qty;

  ITEMS.push({
    kode: prod.kode,
    nama: prod.nama,
    jumlah: qty,
    harga,
    total
  });

  renderTable();
  document.getElementById("qtyInput").value = "";
}

function renderTable() {
  const tb = document.getElementById("tbodyItems");
  tb.innerHTML = "";

  ITEMS.forEach((it, i) => {
    tb.innerHTML += `
      <tr>
        <td class="border p-2 col-kode">${it.kode}</td>
        <td class="border p-2">${it.nama}</td>
        <td class="border p-2">${it.jumlah}</td>
        <td class="border p-2">Rp ${it.harga.toLocaleString("id-ID")}</td>
        <td class="border p-2">Rp ${it.total.toLocaleString("id-ID")}</td>
        <td class="border p-2 text-center">
          <button onclick="hapusItem(${i})"
            class="bg-red-600 text-white px-3 py-1 rounded">
            Hapus
          </button>
        </td>
      </tr>
    `;
  });
}

function hapusItem(i) {
  ITEMS.splice(i, 1);
  renderTable();
}

// --- SUBMIT FORM ---
async function submitForm() {
  const namaUser = document.getElementById("namaUser").value.trim();
  const tanggal = document.getElementById("tanggal").value;
  const kegiatan = document.getElementById("kegiatan").value.trim();
  const kodeBudget = document.getElementById("kodeBudget").value.trim();

  if (!namaUser || !tanggal || !kegiatan || !kodeBudget || ITEMS.length === 0) {
    showNotif("Lengkapi semua form sebelum submit", "red");
    return;
  }

  const btn = document.getElementById("btnSubmit");
  btn.classList.add("loading");
  btn.innerHTML = "Loading...";

  const body = new FormData();
  body.append("action", "submit");
  body.append("namaUser", namaUser);
  body.append("tanggal", tanggal);
  body.append("kegiatan", kegiatan);
  body.append("kodeBudget", kodeBudget);
  body.append("items", JSON.stringify(ITEMS));

  try {
    const url = "https://script.google.com/macros/s/AKfycbyt7lbv7XpZ0mhwRN-VAHIeaWnrJeu0ddm4jx4fN5vgdjEuE6JgqLStRxTuxsNMeidAwA/exec"; // ← ganti URL webapp di sini
    const res = await fetch(url, { method: "POST", body });
    const json = await res.json();

    if (json.success) {
      showNotif("Data berhasil disubmit!", "green");
      ITEMS = [];
      renderTable();
    } else {
      showNotif("Gagal submit: " + json.error, "red");
    }
  } catch (e) {
    showNotif("Error submit: " + e, "red");
  }

  btn.classList.remove("loading");
  btn.innerHTML = "Submit";
}

// --- NOTIF ---
function showNotif(msg, color) {
  const n = document.getElementById("notif");
  n.textContent = msg;
  n.className = `mb-4 p-3 rounded text-white bg-${color}-600`;
  n.classList.remove("hidden");
  setTimeout(() => n.classList.add("hidden"), 3000);
}
</script>

</body>
</html>

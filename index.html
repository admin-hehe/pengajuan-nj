<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input REKAP</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: linear-gradient(to bottom right, #e6f7f5, #f4f9ff);
        }
        .form-control {
            @apply border border-gray-300 rounded px-3 py-2 w-full;
        }
    </style>
</head>
<body class="p-6">

<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow-md">

    <h1 class="text-3xl font-bold mb-2">Form Input — REKAP</h1>
    <p class="text-gray-600 mb-6">
        Masukkan data acara dan produk. Tambah banyak item, total akan dihitung otomatis.
    </p>

    <!-- FORM UTAMA -->
    <div class="grid grid-cols-2 gap-4">

        <div>
            <label class="font-semibold">Tanggal</label>
            <input type="date" id="tanggal" class="form-control">
        </div>

        <div>
            <label class="font-semibold">Kegiatan</label>
            <input type="text" id="kegiatan" class="form-control" placeholder="Contoh: Makan malam bersama">
        </div>

        <div>
            <label class="font-semibold">Kode Budget</label>
            <input type="text" id="kodeBudget" class="form-control" placeholder="ID-230213...">
        </div>

        <div>
            <label class="font-semibold">(Kode Odoo auto)</label>
            <input type="text" id="kodeOdoo" class="form-control bg-gray-100" disabled>
        </div>

        <div>
            <label class="font-semibold">Grand Total</label>
            <input type="text" id="grandTotal" class="form-control bg-gray-100" disabled>
        </div>
    </div>

    <hr class="my-6">

    <!-- DAFTAR PRODUK -->
    <datalist id="produkList"></datalist>

    <h2 class="text-xl font-semibold mb-3">Daftar Item</h2>

    <div id="items"></div>

    <button id="addItemBtn" 
        class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        + Tambah Item
    </button>

    <button id="submitBtn"
        class="mt-4 px-6 py-2 bg-purple-700 text-white rounded hover:bg-purple-800 ml-4">
        Submit
    </button>

</div>

<script>
/* ===========================
    KONFIGURASI
=========================== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1x8gGJphhqmRAOQpqJtZVs4DHatn6joBgJ7WrAbfy7vbatOYtOs9wI_N67r6arJ5wNQ/exec";  // GANTI



/* ===========================
    DATA MASTER (akan diisi)
=========================== */
let masterData = [];

/* ===========================
    LOAD MASTER DI AWAL
=========================== */
async function loadMaster() {
    try {
        const res = await fetch(WEB_APP_URL + "?action=getMaster");
        const data = await res.json();

        masterData = data;

        // isi datalist autocomplete
        const list = document.getElementById("produkList");
        list.innerHTML = "";
        data.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.nama;
            list.appendChild(opt);
        });

    } catch (err) {
        alert("Gagal memuat produk: " + err);
    }
}

loadMaster();



/* ===========================
    TAMBAH ITEM BARU
=========================== */
function addItemRow() {
    const row = document.createElement("div");
    row.className = "item-row flex gap-2 mb-2";

    row.innerHTML = `
        <input type="text" class="kode form-control w-24 bg-gray-100" placeholder="Kode" disabled>

        <input type="text" class="nama-produk form-control flex-1" list="produkList" placeholder="Ketik atau pilih...">

        <input type="number" class="jumlah form-control w-24" placeholder="Qty" min="1">

        <input type="number" class="stok form-control w-24 bg-gray-100" disabled placeholder="Stok">

        <input type="text" class="harga form-control w-28 bg-gray-100" disabled placeholder="Harga">

        <input type="text" class="total form-control w-28 bg-gray-100" disabled placeholder="Total">

        <button class="hapus px-3 py-1 bg-red-600 text-white rounded">Hapus</button>
    `;

    document.getElementById("items").appendChild(row);

    setupRowEvents(row);
}

document.getElementById("addItemBtn").onclick = addItemRow;



/* ===========================
    FORMAT RUPIAH
=========================== */
function formatRupiah(num) {
    return new Intl.NumberFormat("id-ID").format(num);
}



/* ===========================
    HITUNG GRAND TOTAL
=========================== */
function hitungGrandTotal() {
    let sum = 0;
    document.querySelectorAll(".item-row").forEach(row => {
        const total = row.querySelector(".total").value.replace(/\./g, "");
        sum += parseInt(total || 0);
    });
    document.getElementById("grandTotal").value = formatRupiah(sum);
}



/* ===========================
    SETUP EVENT SETIAP BARIS
=========================== */
function setupRowEvents(row) {
    const namaInput = row.querySelector(".nama-produk");
    const kodeInput = row.querySelector(".kode");
    const stokInput = row.querySelector(".stok");
    const hargaInput = row.querySelector(".harga");
    const jumlahInput = row.querySelector(".jumlah");
    const totalInput = row.querySelector(".total");
    const btnHapus = row.querySelector(".hapus");

    // lookup produk
    namaInput.addEventListener("input", () => {
        const nama = namaInput.value.trim();
        const produk = masterData.find(p => p.nama === nama);

        if (produk) {
            kodeInput.value = produk.kode;
            stokInput.value = produk.available;
            hargaInput.value = formatRupiah(produk.harga);
        } else {
            kodeInput.value = "";
            stokInput.value = "";
            hargaInput.value = "";
        }
        hitungGrandTotal();
    });

    // jumlah → total + validasi stok
    jumlahInput.addEventListener("input", () => {
        const stok = parseInt(stokInput.value || 0);
        const qty = parseInt(jumlahInput.value || 0);
        const harga = parseInt(hargaInput.value.replace(/\./g,"") || 0);

        if (qty > stok) {
            jumlahInput.value = stok;
            alert("Jumlah melebihi stok!");
        }

        totalInput.value = formatRupiah(qty * harga);
        hitungGrandTotal();
    });

    // hapus baris
    btnHapus.onclick = () => {
        row.remove();
        hitungGrandTotal();
    };
}



/* ===========================
    SUBMIT DATA
=========================== */
document.getElementById("submitBtn").onclick = async function () {

    const tanggal = document.getElementById("tanggal").value;
    const kegiatan = document.getElementById("kegiatan").value;
    const kodeBudget = document.getElementById("kodeBudget").value;
    const grandTotal = document.getElementById("grandTotal").value;

    const items = [];

    document.querySelectorAll(".item-row").forEach(row => {
        items.push({
            kode: row.querySelector(".kode").value,
            nama: row.querySelector(".nama-produk").value,
            jumlah: row.querySelector(".jumlah").value,
            stok: row.querySelector(".stok").value,
            harga: row.querySelector(".harga").value.replace(/\./g,""),
            total: row.querySelector(".total").value.replace(/\./g,"")
        });
    });

    try {
        const res = await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "submitData",
                tanggal, kegiatan, kodeBudget, grandTotal,
                items: items
            })
        });

        const result = await res.json();

        alert(result.message || "Berhasil disimpan!");

    } catch (err) {
        alert("Gagal kirim: " + err);
    }
};

</script>

</body>
</html>

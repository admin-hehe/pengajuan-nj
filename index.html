<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Form Input â€” REKAP</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* Hide kolom kode di mobile */
  @media (max-width: 640px) {
    .col-kode {
      display: none !important;
    }
    th.col-kode {
      display: none !important;
    }

    /* Panjangkan input nama produk */
    .input-nama-produk {
      width: 100% !important;
    }

    /* Hilangkan TH Aksi */
    th.col-aksi {
      display: none !important;
    }

    /* Perbaiki tombol hapus tetap muncul */
    td.col-aksi button {
      display: block !important;
    }

    /* Perbaiki tampilan input date */
    input[type="date"] {
      background-color: white !important;
      color: black !important;
      -webkit-appearance: menulist !important;
    }
  }

  /* Perbaiki style icon kalender */
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0);
  }
</style>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<!-- NOTIFIKASI BERHASIL -->
<div id="notifSuccess" class="hidden fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50">
  Berhasil disimpan!
</div>

<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
  <h1 class="text-2xl font-bold mb-4">Form Input REKAP</h1>

  <!-- FORM -->
  <form id="rekapForm" class="space-y-4">

    <div>
      <label class="font-semibold">Nama PIC</label>
      <input id="namaUser" type="text"
             class="w-full border rounded p-2"
             required />
    </div>

    <div>
      <label class="font-semibold">Tanggal</label>
      <input id="tanggal" type="date"
             class="w-full border rounded p-2"
             required />
    </div>

    <div>
      <label class="font-semibold">Kegiatan</label>
      <input id="kegiatan" type="text"
             class="w-full border rounded p-2"
             required />
    </div>

    <div>
      <label class="font-semibold">Kode Budget</label>
      <input id="kodeBudget" type="text"
             class="w-full border rounded p-2"
             required />
    </div>

    <!-- TABEL ITEM -->
    <div class="overflow-x-auto">
      <table class="w-full border mt-4 text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">Nama Produk</th>
            <th class="border px-2 py-1 col-kode">Kode</th>
            <th class="border px-2 py-1">Jumlah</th>
            <th class="border px-2 py-1 col-aksi">Aksi</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <!-- BUTTON TAMBAH -->
    <button type="button" onclick="addItemRow()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg">
      + Tambah Produk
    </button>

    <!-- SUBMIT -->
    <button id="submitBtn" type="submit"
            class="w-full bg-green-600 text-white py-3 mt-4 rounded-lg font-semibold flex items-center justify-center gap-2">
      <span id="submitText">Submit</span>
      <span id="loadingSpinner" class="hidden animate-spin border-2 border-white border-t-transparent rounded-full w-5 h-5"></span>
    </button>

  </form>
</div>

<script>
let API_URL = "https://script.google.com/macros/s/AKfycbyt7lbv7XpZ0mhwRN-VAHIeaWnrJeu0ddm4jx4fN5vgdjEuE6JgqLStRxTuxsNMeidAwA/exec"; // <<=== GANTI DI SINI

// Tambah baris produk
function addItemRow() {
  const tbody = document.getElementById("itemsBody");

  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="border p-1">
      <input type="text" class="input-nama-produk w-full border rounded p-1 item-nama" required>
    </td>

    <td class="border p-1 col-kode">
      <input type="text" class="w-full border rounded p-1 item-kode">
    </td>

    <td class="border p-1">
      <input type="number" min="1" class="w-full border rounded p-1 item-jumlah" required>
    </td>

    <td class="border p-1 text-center col-aksi">
      <button type="button" onclick="this.parentElement.parentElement.remove()"
              class="bg-red-500 text-white px-3 py-1 rounded">
        Hapus
      </button>
    </td>
  `;
  tbody.appendChild(row);
}

// SUBMIT
document.getElementById("rekapForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // Validasi manual
  const rows = document.querySelectorAll("#itemsBody tr");
  if (rows.length === 0) {
    alert("Tambahkan minimal 1 produk!");
    return;
  }

  // Loading on
  document.getElementById("submitText").classList.add("hidden");
  document.getElementById("loadingSpinner").classList.remove("hidden");
  document.getElementById("submitBtn").disabled = true;

  let items = [];
  rows.forEach(r => {
    items.push({
      nama: r.querySelector(".item-nama").value,
      kode: r.querySelector(".item-kode").value,
      jumlah: r.querySelector(".item-jumlah").value,
      stok: "",
      harga: "",
      total: ""
    });
  });

  const body = new FormData();
  body.append("action", "submit");
  body.append("namaUser", document.getElementById("namaUser").value);
  body.append("tanggal", document.getElementById("tanggal").value);
  body.append("kegiatan", document.getElementById("kegiatan").value);
  body.append("kodeBudget", document.getElementById("kodeBudget").value);
  body.append("items", JSON.stringify(items));

  fetch(API_URL, { method: "POST", body })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        showNotif();
        document.getElementById("rekapForm").reset();
        document.getElementById("itemsBody").innerHTML = "";
      } else {
        alert("Error: " + JSON.stringify(res));
      }
    })
    .catch(err => alert("Error: " + err))
    .finally(() => {
      document.getElementById("submitText").classList.remove("hidden");
      document.getElementById("loadingSpinner").classList.add("hidden");
      document.getElementById("submitBtn").disabled = false;
    });
});

// Notifikasi
function showNotif() {
  const n = document.getElementById("notifSuccess");
  n.classList.remove("hidden");
  setTimeout(() => n.classList.add("hidden"), 2000);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Form Input REKAP</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .item-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .item-row input, .item-row select { padding: 6px; width: 150px; }
    .item-row .kode { width: 90px; background: #eee; }
    button { padding: 10px 16px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Input REKAP</h2>

<div id="item-container"></div>

<button onclick="addItem()">+ Tambah Item</button>
<br><br>
<button onclick="submitForm()">Kirim</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxs5QGHsHpei0nvIjlZQ-8QdVZr8iI1Ux8-44WHprwTizmf85mbLrhi1cj11nzkKl4NtA/exec"; // GANTI

let masterData = [];

async function loadMaster() {
  try {
    const response = await fetch(SCRIPT_URL + "?action=getMaster");
    const data = await response.json();
    masterData = data;
    addItem(); // tambahkan item pertama
  } catch (e) {
    alert("Gagal memuat MASTER");
  }
}

function addItem() {
  const container = document.getElementById("item-container");

  const row = document.createElement("div");
  row.className = "item-row";

  // dropdown nama produk
  const nama = document.createElement("select");
  nama.innerHTML = `<option value="">Pilih Produk...</option>` +
    masterData.map(p => `<option value="${p.nama}">${p.nama}</option>`).join("");

  // kode (OTOMATIS)
  const kode = document.createElement("input");
  kode.placeholder = "Kode";
  kode.className = "kode";
  kode.readOnly = true;

  // jumlah input
  const jumlah = document.createElement("input");
  jumlah.type = "number";
  jumlah.placeholder = "Jumlah";

  // stok otomatis
  const stok = document.createElement("input");
  stok.placeholder = "Stok";
  stok.readOnly = true;

  // harga otomatis
  const harga = document.createElement("input");
  harga.placeholder = "Harga";
  harga.readOnly = true;

  // total
  const total = document.createElement("input");
  total.placeholder = "Total";
  total.readOnly = true;

  // event: on product change â†’ lookup
  nama.onchange = () => {
    const produk = masterData.find(p => p.nama === nama.value);
    if (produk) {
      kode.value = produk.kode;
      stok.value = produk.stok;
      harga.value = produk.harga;
    }
  };

  // event: hitung total & validasi stok
  jumlah.oninput = () => {
    if (Number(jumlah.value) > Number(stok.value)) {
      alert("Jumlah melebihi stok!");
      jumlah.value = "";
      total.value = "";
      return;
    }
    total.value = Number(jumlah.value || 0) * Number(harga.value || 0);
  };

  row.appendChild(nama);
  row.appendChild(kode);
  row.appendChild(jumlah);
  row.appendChild(stok);
  row.appendChild(harga);
  row.appendChild(total);

  container.appendChild(row);
}

// submit form
async function submitForm() {
  const rows = [...document.querySelectorAll(".item-row")];
  const items = rows.map(r => {
    const inputs = r.querySelectorAll("input, select");
    return {
      nama: inputs[0].value,
      kode: inputs[1].value,
      jumlah: inputs[2].value,
      stok: inputs[3].value,
      harga: inputs[4].value,
      total: inputs[5].value
    };
  });

  try {
    const response = await fetch(SCRIPT_URL + "?action=submit", {
      method: "POST",
      body: JSON.stringify(items),
      headers: { "Content-Type": "application/json" }
    });

    const result = await response.text();
    alert("Berhasil: " + result);
  } catch (e) {
    alert("Gagal kirim: " + e);
  }
}

// mulai
loadMaster();
</script>

</body>
</html>
